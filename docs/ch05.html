<html><head><meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Chapter 5. Managing Google Location History</title><link rel="stylesheet" type="text/css" href="docbook.css"><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot"><link rel="home" href="index.html" title="MobilityDB Workshop"><link rel="up" href="index.html" title="MobilityDB Workshop"><link rel="prev" href="ch04s02.html" title="Transforming GTFS Data for MobilityDB"><link rel="next" href="ch06.html" title="Chapter 6. Managing GPX Data"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter 5. Managing Google Location History</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch04s02.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ch06.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="location_history"></a>Chapter 5. Managing Google Location History</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="sect1"><a href="ch05.html#loading_location_history">Loading Google Location History Data</a></span></dt></dl></div><div class="sect1"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="loading_location_history"></a>Loading Google Location History Data</h2></div></div></div><p>By activating the Location History in your Google account, you let Google track where you go with every mobile device. You can view and manage your Location History information through Google Maps Timeline. The data is provided in JSON format. An example of such a file is as follows.
			</p><pre class="programlisting">
{
"locations" : [ {
	"timestampMs" : "1525373187756",
	"latitudeE7" : 508402936,
	"longitudeE7" : 43413790,
	"accuracy" : 26,
	"activity" : [ {
		"timestampMs" : "1525373185830",
		"activity" : [ {
			"type" : "STILL",
			"confidence" : 44
		}, {
			"type" : "IN_VEHICLE",
			"confidence" : 16
		}, {
			"type" : "IN_ROAD_VEHICLE",
			"confidence" : 16
		}, {
			"type" : "UNKNOWN",
			"confidence" : 12
		}, {
			"type" : "IN_RAIL_VEHICLE",
			"confidence" : 12
...
			</pre><p>
		</p><p>If we want to load location information into MobilityDB we only need the fields <code class="varname">longitudeE7</code>, <code class="varname">latitudeE7</code>, and <code class="varname">timestampMs</code>. To convert the original JSON file into a CSV file containing only these fields we can use <a class="ulink" href="https://stedolan.github.io/jq/" target="_top">jq</a>, a command-line JSON processor. The following command
			</p><pre class="programlisting">
cat location_history.json | jq -r ".locations[] | {latitudeE7, longitudeE7, timestampMs}
| [.latitudeE7, .longitudeE7, .timestampMs] | @csv" &gt; location_history.csv
			</pre><p>
			produces a CSV file of the following format
			</p><pre class="programlisting">
508402936,43413790,"1525373187756"
508402171,43413455,"1525373176729"
508399229,43413304,"1525373143463"
508377525,43411499,"1525373113741"
508374906,43412597,"1525373082542"
508370337,43418136,"1525373052593"
...
			</pre><p>
			The above command works well for files of moderate size since by default jq loads the whole input text in memory. For very large files you may consider the <code class="varname">--stream</code> option of jq, which parses input texts in a streaming fashion.
		</p><p>Now we can import the generated CSV file into PostgreSQL as follows. If the <code class="varname">COPY</code> command throws a permission 
		error, you can instead use the <code class="varname">\copy</code> command of <code class="varname">psql</code> to import the CSV file.
			</p><pre class="programlisting">
DROP TABLE IF EXISTS location_history;

CREATE TABLE location_history (
	latitudeE7 float,
	longitudeE7 float,
	timestampMs bigint,
	date date
);

COPY location_history(latitudeE7, longitudeE7, timestampMs) FROM
'/home/location_history/location_history.csv' DELIMITER ',' CSV;

UPDATE location_history
SET date = date(to_timestamp(timestampMs / 1000.0)::timestamptz);
			</pre><p>
			Notice that we added an attribute <code class="varname">date</code> to the table so we can split the full location history, which can comprise data for several years, by date. Since the timestamps are encoded in milliseconds since 1/1/1970, we divide them by 1,000 and apply the functions <code class="varname">to_timestamp</code> and <code class="varname">date</code> to obtain corresponding date.
		</p><p>
			We can now transform this data into MobilityDB trips as follows.
			</p><pre class="programlisting">
DROP TABLE IF EXISTS locations_mdb;

CREATE TABLE locations_mdb (
	date date NOT NULL,
	trip tgeompoint,
	trajectory geometry,
	PRIMARY KEY (date)
);

INSERT INTO locations_mdb(date, trip)
SELECT date, tgeompoint_seq(array_agg(tgeompoint_inst(
	ST_SetSRID(ST_Point(longitudeE7/1e7, latitudeE7/1e7),4326),
	to_timestamp(timestampMs / 1000.0)::timestamptz) ORDER BY timestampMs))
FROM location_history
GROUP BY date;

UPDATE locations_mdb
SET trajectory = trajectory(trip);
			</pre><p>
			We convert the longitude and latitude values into standard coordinates values by dividing them by 10<sup>7</sup>. These can be converted into PostGIS points in the WGS84 coordinate system with the functions <code class="varname">ST_Point</code> and <code class="varname">ST_SetSRID</code>. Also, we convert the timestamp values in miliseconds to <code class="varname">timestamptz</code> values. We can now apply the function
			<code class="varname">tgeompointinst</code> to create a <code class="varname">tgeompoint</code> of instant duration from the point and the timestamp, collect all temporal points of a day into an array with the function <code class="varname">array_agg</code>, and finally, create a temporal point containing all the locations of a day using function <code class="varname">tgeompointseq</code>. We added to the table a <code class="varname">trajectory</code> attribute to visualize the location history in QGIS is given in <a class="xref" href="ch05.html#location_history_fig" title="Figure 5.1. Visualization of the Google location history loaded into MobilityDB.">Figure 5.1, &#8220;Visualization of the Google location history loaded into MobilityDB.&#8221;</a>.
		</p><div class="figure-float"><div class="figure"><a name="location_history_fig"></a><p class="title"><b>Figure 5.1. Visualization of the Google location history loaded into MobilityDB.</b></p><div class="figure-contents"><div class="mediaobject"><img src="images/LocationHistory.png" alt="Visualization of the Google location history loaded into MobilityDB."></div></div></div><br class="figure-break"></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch04s02.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="ch06.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Transforming GTFS Data for MobilityDB </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> Chapter 6. Managing GPX Data</td></tr></table></div></body></html>
